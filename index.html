<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>space invaders</title>
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">

    <script src="./main.js" defer></script>
    <script src="./scripts/menu.js"></script>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <div id="menu" class="menu activated">
        <div id="main-menu" class="main-menu flex activated">
            <button onclick="play(); jogoInicio()" class="btn-temp-1">iniciar</button>
            <button onclick="multiplayerMenu()" class="btn-temp-1">multiplayer</button>
        </div>
        <div id="multiplayer-menu" class="multiplayer-menu flex disable">
            <button onclick="show_rooms()" class="btn-temp-1">join</button>
            <button onclick="online()" class="btn-temp-1">host</button>
            <button onclick="backToMenu()" class="btn-temp-1">back</button>
        </div>
        <div id="multiplayer-rooms" class="multiplayer-rooms flex disable">
            
            
        </div>
        <button onclick="backToMultiplayerMenu()" id="btn-back" class="disable">back</button>
    </div>
    <main id="canvas" class="canvas disable">
        <div class="hud">
            <p class="pontos">Pontos:</p>
            <button class="btn-pause" class="btn-temp-1"><img src="./assets/svg/pause_icon.svg" alt="pause icon"></button>
        </div>
    </main>
    <script>
        var observer_enemy = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutationRecord) {
                let enemys = []
                Array.prototype.slice.call(document.getElementsByClassName("enemy")).map((enemy) => {
                    enemys.push({
                        id: enemy.id,
                        pos_x: enemy.style.left,
                        pos_y: enemy.style.top
                    })
                });

                ws.send(JSON.stringify({
                    type: "enemys_position",
                    enemys: enemys
                }))

            });
        });

        var observer_bullet = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutationRecord) {
                let enemys = []
                Array.prototype.slice.call(document.getElementsByClassName("enemy")).map((enemy) => {
                    enemys.push({
                        id: enemy.id,
                        pos_x: enemy.style.left,
                        pos_y: enemy.style.top
                    })
                });

                ws.send(JSON.stringify({
                    type: "enemys_position",
                    enemys: enemys
                }))

            });
        });

        const ws = new WebSocket("ws://0.tcp.sa.ngrok.io:16966")
        function online() {
            let username = localStorage.getItem("username")
            if (true) {
                username = prompt("Seu username: ")
                localStorage.setItem("username", username)
            }

            ws.send(JSON.stringify({
                type: "new_player",
                username: localStorage.getItem("username")
            }));

            ws.send(JSON.stringify({
                type: "new_room"
            }));
            localStorage.setItem("role_room", "host")
            

            hostGame()
            jogoInicio()
            if (localStorage.getItem("role_room") == "host") {
                Array.prototype.slice.call(document.getElementsByClassName("enemy")).map((enemy, index) => {
                    observer_enemy.observe(enemy, { attributes : true, attributeFilter : ['style'] });    
                })
            }
        }

        function show_rooms() {
            join()
            ws.send(JSON.stringify({
                type: "view_rooms"
            }));
            
        }

        function enter_room(id) {
            let username = localStorage.getItem("username")
            if (true) {
                username = prompt("Seu username: ")
                localStorage.setItem("username", username)
            }

            ws.send(JSON.stringify({
                type: "new_player",
                username: localStorage.getItem("username")
            }));

            ws.send(JSON.stringify({
                type: "enter_room",
                room_id: id
            }));

            localStorage.setItem("role_room", "guest")

            play()
            var canhao = new Image();
            spawn_canhao(canhao, "player_2")
            joinGame()
        }

        window.addEventListener('keydown',(e)=>{
            if (e.key == 'ArrowRight' || e.key == 'd') {
                let player = document.getElementById("player")
                ws.send(JSON.stringify({
                    type: "player_position",
                    position: `${parseInt(player.style.left) + 10}px`
                }))
            } else if (e.key == 'ArrowLeft' || e.key == 'a'){
                let player = document.getElementById("player")
                ws.send(JSON.stringify({
                    type: "player_position",
                    position: `${parseInt(player.style.left) - 10}px`
                }))
            }else if(e.key == ' '){
                console.log("atirou e enviou kkk")
                ws.send(JSON.stringify({
                    type: "new_bullet",
                    position: `${parseInt(player.style.left)}px`
                }))
            };
        })

        ws.onmessage = (message) => {
            let Message = JSON.parse(message.data)
            if (Message.type == "view_rooms") {
                let rooms = document.getElementById("multiplayer-rooms")
                rooms.innerHTML = ""
                Message.rooms.forEach((room) => {
                    let Room = document.createElement('button')
                    Room.className = "btn-temp-2"
                    Room.innerText = room.name
                    Room.id = room.room_id
                    Room.onclick = () => enter_room(room.room_id)
                    rooms.appendChild(Room)
                });
            }

            if (Message.type == "enter_room") {
                var canhao = new Image();
                spawn_canhao(canhao, "player_2")
            }

            if (Message.type == "player_position") {
                let player_2 = document.getElementById("player_2")
                player_2.style.left = Message.position_x
            }

            if (Message.type == "enemys_position") {    
                let max = parseInt(Message.enemys.length)
                Array.prototype.slice.call(document.getElementsByClassName("enemy")).map((enemy, index) => {
                    if (index > max-1) {
                        enemy.remove()
                    } else {
                        let current_enemy = Message.enemys[index]
                        enemy.style.left = current_enemy.pos_x
                        enemy.style.top = current_enemy.pos_y
                    }
                });
            }

            if (Message.type == "new_bullet") {
                console.log(Message)
                const bala = new Image();
                bala.src = './assets/bullet_line.png';
                bala.style.position = 'absolute'
                bala.width = '50'
                bala.style.top = "670px"
                bala.style.left = Message.position;
                bala.className = "bala"
                canvas.appendChild(bala)
                function resetBala(){
                    atirar = true
                    balaY = (screen_height - 60)
                    clearInterval(anima)  
                    try {
                        canvas.removeChild(bala)
                    } catch (error) {
                        
                    }
                    
                }

                let anima = setInterval(()=>{
                    if(balaY >= 0){
                        bala.style.top = `${balaY}px`
                        balaY-=2   
                        atirar = false;
                    }else{
                        resetBala()
                    }

                },1)
            }
        }

    </script>
</body>
</html>